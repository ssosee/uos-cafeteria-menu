name: Deploy to Lightsail

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  actions: read
  checks: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'corretto'

      - name: Build with Gradle
        run: |
          chmod +x gradlew
          ./gradlew clean build -x test

      - name: Build Docker image
        run: |
          docker build -t uos-restaraunt-kakao-bot-app:${{ github.sha }} .
          docker save uos-restaraunt-kakao-bot-app:${{ github.sha }} | gzip > uos-restaraunt-kakao-bot-app.tar.gz

      - name: Create application-prod.yml
        run: |
          mkdir -p ./src/main/resources
          cat > ./src/main/resources/application-prod.yml << 'EOF'
          ${{ secrets.PROD }}
          EOF

      - name: Create application-api-key.yml
        run: |
          cat > ./src/main/resources/application-api-key.yml << 'EOF'
          ${{ secrets.API_KEY }}
          EOF

      - name: Create application-sentry.yml
        run: |
          cat > ./src/main/resources/application-sentry.yml << 'EOF'
          ${{ secrets.SENTRY }}
          EOF

      - name: Verify files
        run: |
          ls -la ./src/main/resources/

      - name: Copy files to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "uos-restaraunt-kakao-bot-app.tar.gz,src/main/resources/application-prod.yml,src/main/resources/application-api-key.yml,src/main/resources/application-sentry.yml"
          target: "/home/${{ secrets.SERVER_USER }}"

      - name: Deploy on server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            USER_HOME=/home/${{ secrets.SERVER_USER }}
            IMAGE_NAME=uos-restaraunt-kakao-bot-app:${{ github.sha }}
            
            docker load < ${USER_HOME}/uos-restaraunt-kakao-bot-app.tar.gz
            docker stop uos-restaraunt-kakao-bot-app 2>/dev/null || true
            docker rm uos-restaraunt-kakao-bot-app 2>/dev/null || true
            
            docker run -d \
              --name uos-restaraunt-kakao-bot-app \
              --restart unless-stopped \
              --network host \
              -v ${USER_HOME}/src/main/resources/application-prod.yml:/app/config/application-prod.yml:ro \
              -v ${USER_HOME}/src/main/resources/application-api-key.yml:/app/config/application-api-key.yml:ro \
              -v ${USER_HOME}/src/main/resources/application-sentry.yml:/app/config/application-sentry.yml:ro \
              -e SPRING_PROFILES_ACTIVE=prod \
              -e SPRING_CONFIG_LOCATION=classpath:/application.yml,/app/config/application-prod.yml,/app/config/application-api-key.yml,/app/config/application-sentry.yml \
              ${IMAGE_NAME}
            
            rm -f ${USER_HOME}/uos-restaraunt-kakao-bot-app.tar.gz
            docker image prune -af
            sleep 5
            docker logs --tail 30 uos-restaraunt-kakao-bot-app