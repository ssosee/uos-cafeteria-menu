name: Deploy to Lightsail

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  actions: read
  checks: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'corretto'

      - name: Build with Gradle
        run: |
          chmod +x gradlew
          ./gradlew clean build -x test

      - name: Build Docker image
        run: |
          docker build -t uos-restaraunt-kakao-bot-app:${{ github.sha }} .
          docker save uos-restaraunt-kakao-bot-app:${{ github.sha }} | gzip > uos-restaraunt-kakao-bot-app.tar.gz

      - name: make application-secret.yml
        run: |
          ## create application yml files
          cd ./src/main/resources
          
          # yml 파일들 생성
          touch ./application-prod.yml
          touch ./application-api-key.yml
          touch ./application-sentry.yml
          
          # GitHub-Actions 에서 설정한 값을 각 파일에 쓰기
          echo "${{ secrets.PROD }}" >> ./application-prod.yml
          echo "${{ secrets.API_KEY }}" >> ./application-api-key.yml
          echo "${{ secrets.SENTRY }}" >> ./application-sentry.yml
          
          # 확인용 (민감정보 제외하고 파일 존재만 확인)
          ls -la

      - name: Copy files to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "uos-restaraunt-kakao-bot-app.tar.gz,src/main/resources/application-prod.yml,src/main/resources/application-api-key.yml,src/main/resources/application-sentry.yml"
          target: "/home/${{ secrets.SERVER_USER }}"

      - name: Deploy on server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            docker load < /home/${{ secrets.SERVER_USER }}/uos-restaraunt-kakao-bot-app.tar.gz
            docker stop uos-restaraunt-kakao-bot-app 2>/dev/null || true
            docker rm uos-restaraunt-kakao-bot-app 2>/dev/null || true
            docker run -d \
              --name uos-restaraunt-kakao-bot-app \
              --restart unless-stopped \
              -p 8080:8080 \
              -v /home/${{ secrets.SERVER_USER }}/src/main/resources/application-prod.yml:/app/config/application-prod.yml:ro \
              -v /home/${{ secrets.SERVER_USER }}/src/main/resources/application-api-key.yml:/app/config/application-api-key.yml:ro \
              -v /home/${{ secrets.SERVER_USER }}/src/main/resources/application-sentry.yml:/app/config/application-sentry.yml:ro \
              -e SPRING_PROFILES_ACTIVE=prod \
              -e SPRING_CONFIG_LOCATION=classpath:/application.yml,/app/config/application-prod.yml,/app/config/application-api-key.yml,/app/config/application-sentry.yml \
              uos-restaraunt-kakao-bot-app:${{ github.sha }}
            rm -f /home/${{ secrets.SERVER_USER }}/uos-restaraunt-kakao-bot-app.tar.gz
            docker image prune -af
            sleep 5
            docker logs --tail 30 uos-restaraunt-kakao-bot-app

#      ## Slack에 cicd 결과 전송
#      - name: action-slack
#        uses: 8398a7/action-slack@v3
#        with:
#          status: ${{ job.status }}
#          author_name: "[PROD] 배포 결과를 알려드려요"
#          fields: repo,message,commit,author,eventName,ref,took
#        env:
#          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
#        if: always()